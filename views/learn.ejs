<!DOCTYPE html>
<html lang="en">
<%- include('./partials/head') %>
<body class="bg-zinc-100 text-gray-800 max-w-screen-lg mx-auto py-10">
  
  <!-- <%- include('./partials/links') %> -->
  <div class="fixed inset-0 flex justify-center items-center p-10 grow" id="lectures">
    <div class="bg-white rounded-lg h-full self-start shadow-lg max-w-screen-lg w-full flex flex-col py-6">
      <div class="flex px-6 justify-between">
        <h2>Course Content</h2>
        <button class="" onclick="document.getElementById('lectures').classList.toggle('hidden')">
          <i data-feather="x"></i>
        </button>
      </div>
      
      <!-- Course overview -->
      <p class="px-6 mb-4"><%= course.overview %></p>
      
      <!-- Lectures content with top and bottom inset shadow -->
      <div id="lectures-content" class="flex-1 w-full overflow-y-scroll" style="box-shadow: inset 0 10px 8px -8px rgba(0, 0, 0, 0.1), inset 0 -10px 8px -8px rgba(0, 0, 0, 0.1);">
        <!-- Lectures will be dynamically inserted here -->
      </div>
      
      <!-- Bottom navigation buttons (Previous and Next) -->
      <div class="flex justify-end mt-4 px-6 gap-4">
        <button class="py-2 px-6 font-medium border-2 border-black bg-white rounded">Previous</button>
        <button class="py-2 px-6 font-medium border-2 border-black bg-white rounded">Next</button>
      </div>
    </div>
  </div>
  
  
  <!-- Main Content -->
  <div class="space-y-8">
      <!-- Video Player and Description -->
    <div class="flex justify-between gap-4 items-center">

      <h2>FocusLearn</h2>

      <div class="flex gap-4">

        <button class="py-2 px-6 font-medium border-2 border-black bg-white rounded">
          Notes
        </button>

        <div class="bg-white flex border-2 divide-x-2 border-black divide-black rounded">
          <button class="p-2"><i data-feather="chevron-left"></i></button>
          <button class="p-2 px-4 font-medium" onclick="document.getElementById('lectures').classList.toggle('hidden')">Lectures</button>
          <button class="p-2"><i data-feather="chevron-right"></i></button>
        </div>

      </div>

    </div>

    <iframe id="lecture-video" class="w-full h-full aspect-video rounded-lg shadow-xl block" 
      frameborder="0" 
      allow="autoplay; encrypted-media"
      allowfullscreen>
    </iframe>

    <p class="text-xl font-medium text-slate-800 text-center truncate" id="lecture-title"></p>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
  <script>
    feather.replace();

    let currentLecture = null;
    let courseData = null;

    async function fetchCourseDetails() {
      try {
        const response = await fetch('http://127.0.0.1:3000/public/courses/content/<%= course.playlistId %>.json');
        courseData = await response.json();

        const lecturesElement = document.querySelector('#lectures-content');
        lecturesElement.innerHTML = `
          <ul class="font-medium py-2">
            ${courseData.course.lectures.map((lecture, index) => `
              <li class="flex items-center justify-between px-4 py-2 cursor-pointer hover:bg-gray-100" onclick="changeLecture(${index})">
                <div class="flex items-center w-2/3">
                  <span class="text-slate-400 mr-3">
                    <i data-feather="play-circle" class="h-6 w-6"></i>
                  </span>
                  <span class="truncate">${String(index + 1).padStart(2, '0')}. ${lecture.title}</span>
                </div>
                <span class="text-sm">${Math.floor(lecture.duration / 60)} min</span>
              </li>
            `).join('')}
          </ul>
        `;

        changeLecture(0);

      } catch (err) {
        console.error(err);
        const lecturesElement = document.querySelector('#lectures-content');
        lecturesElement.innerHTML = `
          <div class="text-center text-red-600">
            <p>Failed to load lectures. Please try again later.</p>
          </div>
        `;
      }

      feather.replace();

    }

    function changeLecture(index) {
      currentLecture = courseData.course.lectures[index];
      document.getElementById('lectures').classList.toggle('hidden')
      updateLectureContent();
    }

    function updateLectureContent() {
      if (currentLecture) {
      const url = currentLecture.embed.replace('https://www.youtube.com/', 'https://www.youtube-nocookie.com/');
      console.log(url);
      document.getElementById('lecture-video').src = url + '?autoplay=0&mute=0&controls=1&playsinline=1&showinfo=0&rel=0&iv_load_policy=3&modestbranding=1&enablejsapi=1&widgetid=1';
      document.getElementById('lecture-title').textContent = currentLecture.title;

      // Add event listener to track video progress
      const iframe = document.getElementById('lecture-video');
      iframe.onload = function() {
        const player = new YT.Player(iframe, {
        events: {
          'onStateChange': onPlayerStateChange
        }
        });
      };
      }
    }

    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.PLAYING) {
      const duration = event.target.getDuration();
      const watchTime = duration * 0.9;

      setTimeout(() => {
        if (event.target.getPlayerState() == YT.PlayerState.PLAYING) {
        sendProgressUpdate();
        }
      }, watchTime * 1000);
      }
    }

    function sendProgressUpdate() {
      fetch('/progress', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ currentLectureIndex: courseData.course.lectures.indexOf(currentLecture) })
      })
      .then(response => response.json())
      .then(data => console.log('Progress updated:', data))
      .catch(error => console.error('Error updating progress:', error));
    }

    fetchCourseDetails();
  </script>
</body>
</html>